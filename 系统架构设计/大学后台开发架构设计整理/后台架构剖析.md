### 后台架构剖析
#### 1.聊天APP后台架构
##### 1).网络特性及解决方案
###### a.弱网络性
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;弱网络性指手机不断移动(例如地铁、汽车)的特性,处于快速移动中，出现信号不稳、响应时间过长、出现丢包等情况。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因此针对弱网络环境,开发者设计协议的时候必须考虑尽量减少数据往返次数，降低耗时。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于弱网络性，App以长连接的形式连接服务器，可能出现App和服务器连接忽然中断的情况，而且这种情况无法通过连接端口的异常判断。例如当地铁高速行驶的时候网络中断，App无法向服务器的端口发送断开的信息，服务器还以为App一直保持连接，这种现象称为TCP half-open

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP half-open的危害:
- 占用服务器资源(服务器维持连接耗费资源)
- 发送消息的异常

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有效防止TCP half-open的方法是使用应用层心跳包：在App和服务器保持连接过程中，App在规定时间间隔内向服务器发送一个数据(为节省流量，数据可以是单字节字符，因为数据是隔一定时间发送一次，这种数据被形象的称为"心跳数据")。对于未收到心跳数据的连接，服务器主动断开连接。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务器检查App的连接有三种方式:
1. 服务器记录每个连接收到心跳包的最后时间，每隔一段时间检查所有连接，若某个连接最后收到心跳包时间减去当前时间大于超时时间，断开连接。这种方式主要缺点是需要同时检查所有连接，如果连接数量过大，检查连接是对系统的性能影响大。
2. 服务器为每一个连接建立一个定时器，到了规定的超时时间没有收到心跳包定时器就触发，把当前连接断开，如果收到心跳包，就重置定时器，不断重复过程。这种方法主要缺点，为每一个连接设置独立定时器，如果连接数量过大，会建立大量定时器，耗费系统资源。

###### b.对流量敏感性
##### 2).协议
###### a.协议要求
###### b.常用协议
###### c.常用开源服务器
###### d.tcp协议粘包问题及解决方案
##### 3).后台整体架构设计
###### a.连接层
###### b.业务层
###### c.持久层
###### d.工作流程
#### 2.社交APP后台架构
##### 1).基本表结构
##### 2).推拉模式
###### a.推模式
###### b.拉模式
###### c.推拉模式总结
###### d.微博中的应用
##### 3).数据库架构
###### a.自增id
###### b.分表分库策略
##### 4).缓存架构
###### a.分布式缓存
###### b.主从缓存
###### c.防止缓存失效措施
#### 3.LBS APP后台架构
##### 1).地理坐标处理及坐标系认识
##### 2).查找附件的人功能
###### a.MySql空间数据库
###### b.geohash编码
###### c.MongoDB地理位置查询功能
##### 3).基于MongoDB的LBS后台架构
###### a.副本集架构
###### b.分片架构
#### 4.推送服务器后台架构
##### 1).	Android推送 (类似Gopush-Cluster架构)
###### a.App连接推送服务器的流程
###### b.后台推送消息到App的流程
###### c.App获取离线消息的流程
##### 2).iOS推送(基于APNS)
###### a.APNS原理
###### b.APNS推送协议分析
###### c.iOS推送服务器架构

### 未完待续

